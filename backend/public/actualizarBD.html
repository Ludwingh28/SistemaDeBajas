<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actualizar Base de Datos - Sistema de Bajas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 15px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .upload-area {
      border: 3px dashed #11998e;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }

    .upload-area:hover {
      border-color: #38ef7d;
      background: #f0fff4;
    }

    .upload-area.dragging {
      border-color: #38ef7d;
      background: #f0fff4;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }

    .upload-subtext {
      font-size: 13px;
      color: #999;
    }

    .file-input {
      display: none;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .file-info {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
    }

    .file-info.show {
      display: block;
    }

    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .file-details {
      font-size: 14px;
      color: #666;
    }

    .progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-container.show {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e9ecef;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 13px;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #11998e;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .checkbox-group {
      margin: 15px 0;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
    }

    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
      font-size: 13px;
      display: none;
    }

    .warning-box.show {
      display: block;
    }

    .actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üóÑÔ∏è Actualizar Base de Datos</h1>
      <p>Importa nuevas ventas desde Excel</p>
    </div>

    <div class="content">
      <!-- Alerta -->
      <div id="alertContainer"></div>

      <!-- Instrucciones -->
      <div class="section">
        <div class="section-title">üìñ Instrucciones</div>
        <div class="alert alert-info">
          <strong>Archivo requerido:</strong> Excel con hoja "VentasPOD" que contenga las columnas: <strong>Fecha</strong>, <strong>Cliente</strong> (c√≥digo), <strong>Nombre Cliente</strong>.
          <br><br>
          <strong>Nota:</strong> El proceso puede tardar varios minutos dependiendo de la cantidad de registros.
        </div>
      </div>

      <!-- Upload Area -->
      <div class="section">
        <div class="section-title">üìÅ Seleccionar Archivo</div>
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
          <div class="upload-icon">üì§</div>
          <div class="upload-text">Click para seleccionar archivo o arrastra aqu√≠</div>
          <div class="upload-subtext">Archivos soportados: .xlsx, .xls</div>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">

        <!-- Info del archivo -->
        <div class="file-info" id="fileInfo">
          <div class="file-name" id="fileName"></div>
          <div class="file-details" id="fileDetails"></div>

          <!-- Opci√≥n de reemplazar -->
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="reemplazarCheckbox" onchange="toggleWarning()">
              <span>Reemplazar todos los datos existentes</span>
            </label>
          </div>

          <div class="warning-box" id="warningBox">
            ‚ö†Ô∏è <strong>Advertencia:</strong> Esta acci√≥n eliminar√° todas las ventas actuales y las reemplazar√° con los nuevos datos. Esta operaci√≥n no se puede deshacer.
          </div>

          <!-- Acciones -->
          <div class="actions">
            <button class="btn btn-primary" onclick="procesarArchivo()" id="btnProcesar">
              Procesar Archivo
            </button>
            <button class="btn btn-danger" onclick="cancelar()">
              Cancelar
            </button>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
          </div>
          <p style="text-align: center; margin-top: 10px; color: #666;" id="progressText">Procesando...</p>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="section">
        <div class="section-title">üìä Estad√≠sticas Actuales</div>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">-</div>
            <div class="stat-label">Total Ventas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statFechaMin">-</div>
            <div class="stat-label">Fecha M√≠nima</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statFechaMax">-</div>
            <div class="stat-label">Fecha M√°xima</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statDias">-</div>
            <div class="stat-label">D√≠as con Ventas</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedFile = null;

    // Cargar estad√≠sticas al inicio
    window.addEventListener('DOMContentLoaded', () => {
      cargarEstadisticas();
    });

    // Drag & Drop
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragging');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragging');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragging');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      // Validar extensi√≥n
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['xlsx', 'xls'].includes(ext)) {
        showAlert('Por favor selecciona un archivo Excel (.xlsx o .xls)', 'error');
        return;
      }

      selectedFile = file;

      // Mostrar info del archivo
      document.getElementById('fileName').textContent = 'üìÑ ' + file.name;
      document.getElementById('fileDetails').textContent = `Tama√±o: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
      document.getElementById('fileInfo').classList.add('show');
    }

    function toggleWarning() {
      const checkbox = document.getElementById('reemplazarCheckbox');
      const warning = document.getElementById('warningBox');
      warning.classList.toggle('show', checkbox.checked);
    }

    async function procesarArchivo() {
      if (!selectedFile) {
        showAlert('Por favor selecciona un archivo', 'error');
        return;
      }

      const reemplazar = document.getElementById('reemplazarCheckbox').checked;
      const btnProcesar = document.getElementById('btnProcesar');

      // Confirmar si va a reemplazar
      if (reemplazar) {
        if (!confirm('¬øEst√°s seguro de que deseas REEMPLAZAR todos los datos? Esta acci√≥n no se puede deshacer.')) {
          return;
        }
      }

      // Deshabilitar bot√≥n y mostrar progreso
      btnProcesar.disabled = true;
      document.getElementById('progressContainer').classList.add('show');
      updateProgress(10, 'Subiendo archivo...');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('reemplazar', reemplazar);

        updateProgress(30, 'Procesando archivo...');

        const response = await fetch('/api/actualizarBD', {
          method: 'POST',
          body: formData
        });

        updateProgress(90, 'Finalizando...');

        const data = await response.json();

        if (response.ok && data.success) {
          updateProgress(100, '¬°Completado!');
          showAlert(`‚úì ${data.message}. Registros insertados: ${data.registros}`, 'success');
          cancelar();
          cargarEstadisticas();
        } else {
          updateProgress(0, 'Error');
          showAlert('Error: ' + data.message, 'error');
        }
      } catch (error) {
        updateProgress(0, 'Error');
        showAlert('Error al procesar archivo: ' + error.message, 'error');
      } finally {
        btnProcesar.disabled = false;
        setTimeout(() => {
          document.getElementById('progressContainer').classList.remove('show');
        }, 2000);
      }
    }

    function updateProgress(percent, text) {
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressFill').textContent = percent + '%';
      document.getElementById('progressText').textContent = text;
    }

    function cancelar() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('fileInfo').classList.remove('show');
      document.getElementById('reemplazarCheckbox').checked = false;
      document.getElementById('warningBox').classList.remove('show');
    }

    async function cargarEstadisticas() {
      try {
        const response = await fetch('/api/ventas/estadisticas');
        const data = await response.json();

        if (data.total !== undefined) {
          document.getElementById('statTotal').textContent = data.total.toLocaleString();
          document.getElementById('statFechaMin').textContent = data.min_fecha || '-';
          document.getElementById('statFechaMax').textContent = data.max_fecha || '-';
          document.getElementById('statDias').textContent = data.dias || '-';
        }
      } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
      }
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alertClass = type === 'success' ? 'alert-success' : 'alert-error';

      container.innerHTML = `
        <div class="alert ${alertClass}">
          ${message}
        </div>
      `;

      setTimeout(() => {
        container.innerHTML = '';
      }, 10000);
    }
  </script>
</body>
</html>
